#!/usr/bin/env python

import os
import autochecker
import subprocess
import sys
from datetime import datetime, timedelta

autochecker.assert_test_dir()

tests = autochecker.test_files()
answers = autochecker.answer_files()
run_command = autochecker.run_command(sys.argv[1])


total_run_time = timedelta()
for i in range(len(tests)):
    print "running test " + str(i) + "/" + str(len(tests))

    before = datetime.now()
    output = subprocess.check_output(run_command, stdin=open(tests[i]))
    after = datetime.now()
    total_run_time += after - before

    expected = open(answers[i]).read()
    if output.strip() != expected.strip():
        tmp = open('TEMP.ans', 'w')
        tmp.write(output)
        tmp.close()

        tmpout = open("TEMP.out", "w")
        print answers[i]
        ret = subprocess.call(["diff", "TEMP.ans", answers[i]], stdout=tmpout)
        tmpout.close()

        tmpout = open("TEMP.out", "r")
        print "Failed!"
        print tmpout.read()

        os.remove("TEMP.out")
        os.remove("TEMP.ans")
        sys.exit(1)

print "Passed!"
print "Total runtime in seconds: " + str(total_run_time.total_seconds())
